<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="respectËá¥Êï¨Èõ∑Á•û  start‰ªé AVFormatContext ÔºàËß£Â∞ÅË£ÖÁªìÊûÑ‰ΩìÔºâ ÂÖ•Âè£ÂºÄÂßãÂêß ‚Ä¶ 123456789101112131415161718192021222324252627282930libavformat/options.cAVFormatContext *avformat_alloc_context(void)&amp;#123;    FFFormatContext *con">
<meta name="keywords" content="ffmepg">
<meta property="og:type" content="article">
<meta property="og:title" content="ffmepgÊ∫êÁ†Å‰πãhttpÂ≠¶‰π†Á¨îËÆ∞">
<meta property="og:url" content="https://blackox.cn/2022/12/22/ffmepgÊ∫êÁ†Å‰πãhttpÂ≠¶‰π†Á¨îËÆ∞/index.html">
<meta property="og:site_name" content="BLACK_OX">
<meta property="og:description" content="respectËá¥Êï¨Èõ∑Á•û  start‰ªé AVFormatContext ÔºàËß£Â∞ÅË£ÖÁªìÊûÑ‰ΩìÔºâ ÂÖ•Âè£ÂºÄÂßãÂêß ‚Ä¶ 123456789101112131415161718192021222324252627282930libavformat/options.cAVFormatContext *avformat_alloc_context(void)&amp;#123;    FFFormatContext *con">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://blackox.cn/images/20130914204051125.jpeg">
<meta property="og:image" content="https://blackox.cn/images/20230112_115542_image.png">
<meta property="og:updated_time" content="2023-01-12T04:00:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ffmepgÊ∫êÁ†Å‰πãhttpÂ≠¶‰π†Á¨îËÆ∞">
<meta name="twitter:description" content="respectËá¥Êï¨Èõ∑Á•û  start‰ªé AVFormatContext ÔºàËß£Â∞ÅË£ÖÁªìÊûÑ‰ΩìÔºâ ÂÖ•Âè£ÂºÄÂßãÂêß ‚Ä¶ 123456789101112131415161718192021222324252627282930libavformat/options.cAVFormatContext *avformat_alloc_context(void)&amp;#123;    FFFormatContext *con">
<meta name="twitter:image" content="https://blackox.cn/images/20130914204051125.jpeg">



  <link rel="alternate" href="/atom.xml" title="BLACK_OX" type="application/atom+xml">



  
  
  <link rel="canonical" href="https://blackox.cn/2022/12/22/ffmepgÊ∫êÁ†Å‰πãhttpÂ≠¶‰π†Á¨îËÆ∞/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ffmepgÊ∫êÁ†Å‰πãhttpÂ≠¶‰π†Á¨îËÆ∞ | BLACK_OX</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">BLACK_OX</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">The palest ink is better than the best memory</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="ÂàáÊç¢ÂØºËà™Ê†è">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>È¶ñÈ°µ</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Ê†áÁ≠æ</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>ÂàÜÁ±ª</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>ÂΩíÊ°£</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>ÂÖ≥‰∫é</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>ÊêúÁ¥¢</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="ÊêúÁ¥¢..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/blackox626" class="github-corner" title="Fo Fo Fo Follow me üòÅ" aria-label="Fo Fo Fo Follow me üòÅ" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blackox.cn/2022/12/22/ffmepgÊ∫êÁ†Å‰πãhttpÂ≠¶‰π†Á¨îËÆ∞/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="BLACK_OX">
      <meta itemprop="description" content="Developer...">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BLACK_OX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ffmepgÊ∫êÁ†Å‰πãhttpÂ≠¶‰π†Á¨îËÆ∞

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">ÂèëË°®‰∫é</span>
              

              
                
              

              <time title="ÂàõÂª∫Êó∂Èó¥Ôºö2022-12-22 15:45:37" itemprop="dateCreated datePublished" datetime="2022-12-22T15:45:37+08:00">2022-12-22</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">ÂàÜÁ±ª‰∫é</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ffmepg/" itemprop="url" rel="index"><span itemprop="name">ffmepg</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">ËØÑËÆ∫Êï∞Ôºö</span>
                <a href="/2022/12/22/ffmepgÊ∫êÁ†Å‰πãhttpÂ≠¶‰π†Á¨îËÆ∞/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2022/12/22/ffmepgÊ∫êÁ†Å‰πãhttpÂ≠¶‰π†Á¨îËÆ∞/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/2022/12/22/ffmepgÊ∫êÁ†Å‰πãhttpÂ≠¶‰π†Á¨îËÆ∞/" class="leancloud_visitors" data-flag-title="ffmepgÊ∫êÁ†Å‰πãhttpÂ≠¶‰π†Á¨îËÆ∞">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">ÈòÖËØªÊ¨°Êï∞Ôºö</span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Êú¨ÊñáÂ≠óÊï∞Ôºö</span>
                
                <span title="Êú¨ÊñáÂ≠óÊï∞">169k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">ÈòÖËØªÊó∂Èïø &asymp;</span>
                
                <span title="ÈòÖËØªÊó∂Èïø">2:33</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="respect"><a href="#respect" class="headerlink" title="respect"></a>respect</h3><p>Ëá¥Êï¨Èõ∑Á•û</p>
<p><img src="/images/20130914204051125.jpeg" alt="Ëá¥Êï¨Èõ∑Á•û"></p>
<h3 id="start"><a href="#start" class="headerlink" title="start"></a>start</h3><p>‰ªé AVFormatContext ÔºàËß£Â∞ÅË£ÖÁªìÊûÑ‰ΩìÔºâ ÂÖ•Âè£ÂºÄÂßãÂêß ‚Ä¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">libavformat/options.c</span><br><span class="line"></span><br><span class="line"><span class="function">AVFormatContext *<span class="title">avformat_alloc_context</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FFFormatContext *<span class="keyword">const</span> si = av_mallocz(<span class="keyword">sizeof</span>(*si));</span><br><span class="line">    AVFormatContext *s;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!si)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    s = &amp;si-&gt;pub;</span><br><span class="line">    s-&gt;av_class = &amp;av_format_context_class;</span><br><span class="line">    <span class="comment">/// ioÂÖ•Âè£ </span></span><br><span class="line">    s-&gt;io_open  = io_open_default;</span><br><span class="line">    s-&gt;io_close = ff_format_io_close_default;</span><br><span class="line">    s-&gt;io_close2= io_close2_default;</span><br><span class="line"></span><br><span class="line">    av_opt_set_defaults(s);</span><br><span class="line"></span><br><span class="line">    si-&gt;pkt = av_packet_alloc();</span><br><span class="line">    si-&gt;parse_pkt = av_packet_alloc();</span><br><span class="line">    <span class="keyword">if</span> (!si-&gt;pkt || !si-&gt;parse_pkt) &#123;</span><br><span class="line">        avformat_free_context(s);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    si-&gt;shortest_end = AV_NOPTS_VALUE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">libavformat/demux.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avformat_open_input</span><span class="params">(AVFormatContext **ps, <span class="keyword">const</span> <span class="keyword">char</span> *filename,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> AVInputFormat *fmt, AVDictionary **options)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AVFormatContext *s = *ps;</span><br><span class="line">    FFFormatContext *si;</span><br><span class="line">    AVDictionary *tmp = <span class="literal">NULL</span>;</span><br><span class="line">    ID3v2ExtraMeta *id3v2_extra_meta = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!s &amp;&amp; !(s = avformat_alloc_context()))</span><br><span class="line">        <span class="keyword">return</span> AVERROR(ENOMEM);</span><br><span class="line">    si = ffformatcontext(s);</span><br><span class="line">    <span class="keyword">if</span> (!s-&gt;av_class) &#123;</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Input context has not been properly allocated by avformat_alloc_context() and is not NULL either\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> AVERROR(EINVAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fmt)</span><br><span class="line">        s-&gt;iformat = fmt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options)</span><br><span class="line">        av_dict_copy(&amp;tmp, *options, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;pb) <span class="comment">// must be before any goto fail</span></span><br><span class="line">        s-&gt;flags |= AVFMT_FLAG_CUSTOM_IO;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ret = av_opt_set_dict(s, &amp;tmp)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(s-&gt;url = av_strdup(filename ? filename : <span class="string">""</span>))) &#123;</span><br><span class="line">        ret = AVERROR(ENOMEM);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// ÂàùÂßãÂåñËæìÂÖ•ÊµÅÁöÑ‰ø°ÊÅØ„ÄÇËøôÈáå‰ºöÂàùÂßãÂåñAVInputFormat</span></span><br><span class="line">    <span class="keyword">if</span> ((ret = init_input(s, filename, &amp;tmp)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    s-&gt;probe_score = ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!s-&gt;protocol_whitelist &amp;&amp; s-&gt;pb &amp;&amp; s-&gt;pb-&gt;protocol_whitelist) &#123;</span><br><span class="line">        s-&gt;protocol_whitelist = av_strdup(s-&gt;pb-&gt;protocol_whitelist);</span><br><span class="line">        <span class="keyword">if</span> (!s-&gt;protocol_whitelist) &#123;</span><br><span class="line">            ret = AVERROR(ENOMEM);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!s-&gt;protocol_blacklist &amp;&amp; s-&gt;pb &amp;&amp; s-&gt;pb-&gt;protocol_blacklist) &#123;</span><br><span class="line">        s-&gt;protocol_blacklist = av_strdup(s-&gt;pb-&gt;protocol_blacklist);</span><br><span class="line">        <span class="keyword">if</span> (!s-&gt;protocol_blacklist) &#123;</span><br><span class="line">            ret = AVERROR(ENOMEM);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;format_whitelist &amp;&amp; av_match_list(s-&gt;iformat-&gt;name, s-&gt;format_whitelist, <span class="string">','</span>) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        av_log(s, AV_LOG_ERROR, <span class="string">"Format not on whitelist \'%s\'\n"</span>, s-&gt;format_whitelist);</span><br><span class="line">        ret = AVERROR(EINVAL);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    avio_skip(s-&gt;pb, s-&gt;skip_initial_bytes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check filename in case an image number is expected. */</span></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;iformat-&gt;flags &amp; AVFMT_NEEDNUMBER) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!av_filename_number_test(filename)) &#123;</span><br><span class="line">            ret = AVERROR(EINVAL);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s-&gt;duration = s-&gt;start_time = AV_NOPTS_VALUE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate private data. */</span></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;iformat-&gt;priv_data_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(s-&gt;priv_data = av_mallocz(s-&gt;iformat-&gt;priv_data_size))) &#123;</span><br><span class="line">            ret = AVERROR(ENOMEM);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s-&gt;iformat-&gt;priv_class) &#123;</span><br><span class="line">            *(<span class="keyword">const</span> AVClass **) s-&gt;priv_data = s-&gt;iformat-&gt;priv_class;</span><br><span class="line">            av_opt_set_defaults(s-&gt;priv_data);</span><br><span class="line">            <span class="keyword">if</span> ((ret = av_opt_set_dict(s-&gt;priv_data, &amp;tmp)) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* e.g. AVFMT_NOFILE formats will not have an AVIOContext */</span></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;pb)</span><br><span class="line">        ff_id3v2_read_dict(s-&gt;pb, &amp;si-&gt;id3v2_meta, ID3v2_DEFAULT_MAGIC, &amp;id3v2_extra_meta);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;iformat-&gt;read_header)</span><br><span class="line">        <span class="keyword">if</span> ((ret = s-&gt;iformat-&gt;read_header(s)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s-&gt;iformat-&gt;flags_internal &amp; FF_FMT_INIT_CLEANUP)</span><br><span class="line">                <span class="keyword">goto</span> close;</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!s-&gt;metadata) &#123;</span><br><span class="line">        s-&gt;metadata    = si-&gt;id3v2_meta;</span><br><span class="line">        si-&gt;id3v2_meta = <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (si-&gt;id3v2_meta) &#123;</span><br><span class="line">        av_log(s, AV_LOG_WARNING, <span class="string">"Discarding ID3 tags because more suitable tags were found.\n"</span>);</span><br><span class="line">        av_dict_free(&amp;si-&gt;id3v2_meta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (id3v2_extra_meta) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(s-&gt;iformat-&gt;name, <span class="string">"mp3"</span>) || !<span class="built_in">strcmp</span>(s-&gt;iformat-&gt;name, <span class="string">"aac"</span>) ||</span><br><span class="line">            !<span class="built_in">strcmp</span>(s-&gt;iformat-&gt;name, <span class="string">"tta"</span>) || !<span class="built_in">strcmp</span>(s-&gt;iformat-&gt;name, <span class="string">"wav"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((ret = ff_id3v2_parse_apic(s, id3v2_extra_meta)) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> close;</span><br><span class="line">            <span class="keyword">if</span> ((ret = ff_id3v2_parse_chapters(s, id3v2_extra_meta)) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> close;</span><br><span class="line">            <span class="keyword">if</span> ((ret = ff_id3v2_parse_priv(s, id3v2_extra_meta)) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> close;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            av_log(s, AV_LOG_DEBUG, <span class="string">"demuxer does not support additional id3 data, skipping\n"</span>);</span><br><span class="line">        ff_id3v2_free_extra_meta(&amp;id3v2_extra_meta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ret = avformat_queue_attached_pictures(s)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> close;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;pb &amp;&amp; !si-&gt;data_offset)</span><br><span class="line">        si-&gt;data_offset = avio_tell(s-&gt;pb);</span><br><span class="line"></span><br><span class="line">    si-&gt;raw_packet_buffer_size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    update_stream_avctx(s);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options) &#123;</span><br><span class="line">        av_dict_free(options);</span><br><span class="line">        *options = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    *ps = s;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">close:</span><br><span class="line">    <span class="keyword">if</span> (s-&gt;iformat-&gt;read_close)</span><br><span class="line">        s-&gt;iformat-&gt;read_close(s);</span><br><span class="line">fail:</span><br><span class="line">    ff_id3v2_free_extra_meta(&amp;id3v2_extra_meta);</span><br><span class="line">    av_dict_free(&amp;tmp);</span><br><span class="line">    <span class="keyword">if</span> (s-&gt;pb &amp;&amp; !(s-&gt;flags &amp; AVFMT_FLAG_CUSTOM_IO))</span><br><span class="line">        avio_closep(&amp;s-&gt;pb);</span><br><span class="line">    avformat_free_context(s);</span><br><span class="line">    *ps = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">libavformat/demux.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">init_input</span><span class="params">(AVFormatContext *s, <span class="keyword">const</span> <span class="keyword">char</span> *filename,</span></span></span><br><span class="line"><span class="function"><span class="params">                      AVDictionary **options)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    AVProbeData pd = &#123; filename, <span class="literal">NULL</span>, <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">int</span> score = AVPROBE_SCORE_RETRY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">///ÂàùÂßãÂåñÁöÑËøáÁ®ã s-&gt;pb ËøòÊ≤°ÂàõÂª∫Â•Ω</span></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;pb) &#123;</span><br><span class="line">        s-&gt;flags |= AVFMT_FLAG_CUSTOM_IO;</span><br><span class="line">        <span class="keyword">if</span> (!s-&gt;iformat)</span><br><span class="line">            <span class="keyword">return</span> av_probe_input_buffer2(s-&gt;pb, &amp;s-&gt;iformat, filename,</span><br><span class="line">                                          s, <span class="number">0</span>, s-&gt;format_probesize);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s-&gt;iformat-&gt;flags &amp; AVFMT_NOFILE)</span><br><span class="line">            av_log(s, AV_LOG_WARNING, <span class="string">"Custom AVIOContext makes no sense and "</span></span><br><span class="line">                                      <span class="string">"will be ignored with AVFMT_NOFILE format.\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Guess file format. */</span></span><br><span class="line">    <span class="comment">// av_probe_input_format2 È¶ñÊ¨°Âà§Êñ≠inputformatÊ†ºÂºè iformatÔºåËøô‰∏ÄÊ≠•ÈÄöÂ∏∏Âà§Êñ≠‰∏çÂá∫Êù•</span></span><br><span class="line">    <span class="keyword">if</span> ((s-&gt;iformat &amp;&amp; s-&gt;iformat-&gt;flags &amp; AVFMT_NOFILE) ||</span><br><span class="line">        (!s-&gt;iformat &amp;&amp; (s-&gt;iformat = av_probe_input_format2(&amp;pd, <span class="number">0</span>, &amp;score))))</span><br><span class="line">        <span class="keyword">return</span> score;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// io_open Â∞±ÊòØÂâçÈù¢ËµãÂÄºÁöÑÂÖ•Âè£ÂáΩÊï∞ io_open_default</span></span><br><span class="line">    <span class="keyword">if</span> ((ret = s-&gt;io_open(s, &amp;s-&gt;pb, filename, AVIO_FLAG_READ | s-&gt;avio_flags, options)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;iformat)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// av_probe_input_buffer2ÂÜçÊ¨°Âà§Êñ≠inputformatÊ†ºÂºè iformatÔºåÈÄöËøábufÂ™í‰ΩìÊµÅÊï∞ÊçÆÂà§Êñ≠„ÄÇ</span></span><br><span class="line">    <span class="keyword">return</span> av_probe_input_buffer2(s-&gt;pb, &amp;s-&gt;iformat, filename,</span><br><span class="line">                                  s, <span class="number">0</span>, s-&gt;format_probesize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">libavformat/options.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">io_open_default</span><span class="params">(AVFormatContext *s, AVIOContext **pb,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> <span class="keyword">char</span> *url, <span class="keyword">int</span> flags, AVDictionary **options)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> loglevel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(url, s-&gt;url) ||</span><br><span class="line">        s-&gt;iformat &amp;&amp; !<span class="built_in">strcmp</span>(s-&gt;iformat-&gt;name, <span class="string">"image2"</span>) ||</span><br><span class="line">        s-&gt;oformat &amp;&amp; !<span class="built_in">strcmp</span>(s-&gt;oformat-&gt;name, <span class="string">"image2"</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        loglevel = AV_LOG_DEBUG;</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        loglevel = AV_LOG_INFO;</span><br><span class="line"></span><br><span class="line">    av_log(s, loglevel, <span class="string">"Opening \'%s\' for %s\n"</span>, url, flags &amp; AVIO_FLAG_WRITE ? <span class="string">"writing"</span> : <span class="string">"reading"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// io-open</span></span><br><span class="line">    <span class="keyword">return</span> ffio_open_whitelist(pb, url, flags, &amp;s-&gt;interrupt_callback, options, s-&gt;protocol_whitelist, s-&gt;protocol_blacklist);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line">libavformat/aviobuf.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ffio_open_whitelist</span><span class="params">(AVIOContext **s, <span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> AVIOInterruptCB *int_cb, AVDictionary **options,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">char</span> *whitelist, <span class="keyword">const</span> <span class="keyword">char</span> *blacklist</span></span></span><br><span class="line"><span class="function"><span class="params">                        )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    URLContext *h;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    *s = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// ÂàõÂª∫ URLContext</span></span><br><span class="line">    err = ffurl_open_whitelist(&amp;h, filename, flags, int_cb, options, whitelist, blacklist, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    <span class="comment">/// ÂàõÂª∫AVIOContext ËµãÂÄº urlcontext</span></span><br><span class="line">    err = ffio_fdopen(s, h);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ffurl_close(h);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line">libavformat/avio.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ffurl_alloc</span><span class="params">(URLContext **puc, <span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> AVIOInterruptCB *int_cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> URLProtocol *p = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">/// Ê†πÊçÆfilename ÊâæÂà∞ http</span></span><br><span class="line">    p = url_find_protocol(filename);</span><br><span class="line">    <span class="keyword">if</span> (p)</span><br><span class="line">        <span class="comment">/// ÂàõÂª∫URLContext Âπ∂ËµãÂÄº URLProtocol</span></span><br><span class="line">       <span class="keyword">return</span> url_alloc_for_protocol(puc, p, filename, flags, int_cb);</span><br><span class="line"></span><br><span class="line">    *puc = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> AVERROR_PROTOCOL_NOT_FOUND;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">url_alloc_for_protocol</span><span class="params">(URLContext **puc, <span class="keyword">const</span> URLProtocol *up,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">const</span> AVIOInterruptCB *int_cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    URLContext *uc;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_NETWORK</span></span><br><span class="line">    <span class="keyword">if</span> (up-&gt;flags &amp; URL_PROTOCOL_FLAG_NETWORK &amp;&amp; !ff_network_init())</span><br><span class="line">        <span class="keyword">return</span> AVERROR(EIO);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; AVIO_FLAG_READ) &amp;&amp; !up-&gt;url_read) &#123;</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR,</span><br><span class="line">               <span class="string">"Impossible to open the '%s' protocol for reading\n"</span>, up-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> AVERROR(EIO);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; AVIO_FLAG_WRITE) &amp;&amp; !up-&gt;url_write) &#123;</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR,</span><br><span class="line">               <span class="string">"Impossible to open the '%s' protocol for writing\n"</span>, up-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> AVERROR(EIO);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// ÂàõÂª∫  URLContext</span></span><br><span class="line">    uc = av_mallocz(<span class="keyword">sizeof</span>(URLContext) + <span class="built_in">strlen</span>(filename) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (!uc) &#123;</span><br><span class="line">        err = AVERROR(ENOMEM);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    uc-&gt;av_class = &amp;ffurl_context_class;</span><br><span class="line">    uc-&gt;filename = (<span class="keyword">char</span> *)&amp;uc[<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">strcpy</span>(uc-&gt;filename, filename);</span><br><span class="line">    <span class="comment">/// ËµãÂÄº urlprotocal</span></span><br><span class="line">    uc-&gt;prot            = up;</span><br><span class="line">    uc-&gt;flags           = flags;</span><br><span class="line">    uc-&gt;is_streamed     = <span class="number">0</span>; <span class="comment">/* default = not streamed */</span></span><br><span class="line">    uc-&gt;max_packet_size = <span class="number">0</span>; <span class="comment">/* default: stream file */</span></span><br><span class="line">    <span class="comment">/// httpprotocal ËÆæÁΩÆËøá‰∫Ü priv_data ‰∏∫ HTTPContext</span></span><br><span class="line">    <span class="keyword">if</span> (up-&gt;priv_data_size) &#123;</span><br><span class="line">        uc-&gt;priv_data = av_mallocz(up-&gt;priv_data_size);</span><br><span class="line">        <span class="keyword">if</span> (!uc-&gt;priv_data) &#123;</span><br><span class="line">            err = AVERROR(ENOMEM);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (up-&gt;priv_data_class) &#123;</span><br><span class="line">            <span class="keyword">char</span> *start;</span><br><span class="line">            *(<span class="keyword">const</span> AVClass **)uc-&gt;priv_data = up-&gt;priv_data_class;</span><br><span class="line">            av_opt_set_defaults(uc-&gt;priv_data);</span><br><span class="line">            <span class="keyword">if</span> (av_strstart(uc-&gt;filename, up-&gt;name, (<span class="keyword">const</span> <span class="keyword">char</span>**)&amp;start) &amp;&amp; *start == <span class="string">','</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> ret= <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">char</span> *p= start;</span><br><span class="line">                <span class="keyword">char</span> sep= *++p;</span><br><span class="line">                <span class="keyword">char</span> *key, *val;</span><br><span class="line">                p++;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strcmp</span>(up-&gt;name, <span class="string">"subfile"</span>))</span><br><span class="line">                    ret = AVERROR(EINVAL);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(ret &gt;= <span class="number">0</span> &amp;&amp; (key= <span class="built_in">strchr</span>(p, sep)) &amp;&amp; p&lt;key &amp;&amp; (val = <span class="built_in">strchr</span>(key+<span class="number">1</span>, sep)))&#123;</span><br><span class="line">                    *val= *key= <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(p, <span class="string">"start"</span>) &amp;&amp; <span class="built_in">strcmp</span>(p, <span class="string">"end"</span>)) &#123;</span><br><span class="line">                        ret = AVERROR_OPTION_NOT_FOUND;</span><br><span class="line">                    &#125; <span class="keyword">else</span></span><br><span class="line">                        ret= av_opt_set(uc-&gt;priv_data, p, key+<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (ret == AVERROR_OPTION_NOT_FOUND)</span><br><span class="line">                        av_log(uc, AV_LOG_ERROR, <span class="string">"Key '%s' not found.\n"</span>, p);</span><br><span class="line">                    *val= *key= sep;</span><br><span class="line">                    p= val+<span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(ret&lt;<span class="number">0</span> || p!=key)&#123;</span><br><span class="line">                    av_log(uc, AV_LOG_ERROR, <span class="string">"Error parsing options string %s\n"</span>, start);</span><br><span class="line">                    av_freep(&amp;uc-&gt;priv_data);</span><br><span class="line">                    av_freep(&amp;uc);</span><br><span class="line">                    err = AVERROR(EINVAL);</span><br><span class="line">                    <span class="keyword">goto</span> fail;</span><br><span class="line">                &#125;</span><br><span class="line">                memmove(start, key+<span class="number">1</span>, <span class="built_in">strlen</span>(key));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (int_cb)</span><br><span class="line">        uc-&gt;interrupt_callback = *int_cb;</span><br><span class="line"></span><br><span class="line">    *puc = uc;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">fail:</span><br><span class="line">    *puc = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (uc)</span><br><span class="line">        av_freep(&amp;uc-&gt;priv_data);</span><br><span class="line">    av_freep(&amp;uc);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_NETWORK</span></span><br><span class="line">    <span class="keyword">if</span> (up-&gt;flags &amp; URL_PROTOCOL_FLAG_NETWORK)</span><br><span class="line">        ff_network_close();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ffurl_open_whitelist</span><span class="params">(URLContext **puc, <span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> AVIOInterruptCB *int_cb, AVDictionary **options,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">char</span> *whitelist, <span class="keyword">const</span> <span class="keyword">char</span>* blacklist,</span></span></span><br><span class="line"><span class="function"><span class="params">                         URLContext *parent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AVDictionary *tmp_opts = <span class="literal">NULL</span>;</span><br><span class="line">    AVDictionaryEntry *e;</span><br><span class="line">    <span class="comment">/// ÂàõÂª∫ URLContext</span></span><br><span class="line">    <span class="keyword">int</span> ret = ffurl_alloc(puc, filename, flags, int_cb);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    <span class="keyword">if</span> (parent) &#123;</span><br><span class="line">        ret = av_opt_copy(*puc, parent);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (options &amp;&amp;</span><br><span class="line">        (ret = av_opt_set_dict(*puc, options)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    <span class="keyword">if</span> (options &amp;&amp; (*puc)-&gt;prot-&gt;priv_data_class &amp;&amp;</span><br><span class="line">        (ret = av_opt_set_dict((*puc)-&gt;priv_data, options)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!options)</span><br><span class="line">        options = &amp;tmp_opts;</span><br><span class="line"></span><br><span class="line">    av_assert0(!whitelist ||</span><br><span class="line">               !(e=av_dict_get(*options, <span class="string">"protocol_whitelist"</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) ||</span><br><span class="line">               !<span class="built_in">strcmp</span>(whitelist, e-&gt;value));</span><br><span class="line">    av_assert0(!blacklist ||</span><br><span class="line">               !(e=av_dict_get(*options, <span class="string">"protocol_blacklist"</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) ||</span><br><span class="line">               !<span class="built_in">strcmp</span>(blacklist, e-&gt;value));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ret = av_dict_set(options, <span class="string">"protocol_whitelist"</span>, whitelist, <span class="number">0</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ret = av_dict_set(options, <span class="string">"protocol_blacklist"</span>, blacklist, <span class="number">0</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ret = av_opt_set_dict(*puc, options)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// ÂèëËµ∑ÈìæÊé•</span></span><br><span class="line">    ret = ffurl_connect(*puc, options);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ret)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">fail:</span><br><span class="line">    ffurl_closep(puc);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">libavformat/avio.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ffurl_connect</span><span class="params">(URLContext *uc, AVDictionary **options)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    AVDictionary *tmp_opts = <span class="literal">NULL</span>;</span><br><span class="line">    AVDictionaryEntry *e;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!options)</span><br><span class="line">        options = &amp;tmp_opts;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check that URLContext was initialized correctly and lists are matching if set</span></span><br><span class="line">    av_assert0(!(e=av_dict_get(*options, <span class="string">"protocol_whitelist"</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) ||</span><br><span class="line">               (uc-&gt;protocol_whitelist &amp;&amp; !<span class="built_in">strcmp</span>(uc-&gt;protocol_whitelist, e-&gt;value)));</span><br><span class="line">    av_assert0(!(e=av_dict_get(*options, <span class="string">"protocol_blacklist"</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) ||</span><br><span class="line">               (uc-&gt;protocol_blacklist &amp;&amp; !<span class="built_in">strcmp</span>(uc-&gt;protocol_blacklist, e-&gt;value)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uc-&gt;protocol_whitelist &amp;&amp; av_match_list(uc-&gt;prot-&gt;name, uc-&gt;protocol_whitelist, <span class="string">','</span>) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        av_log(uc, AV_LOG_ERROR, <span class="string">"Protocol '%s' not on whitelist '%s'!\n"</span>, uc-&gt;prot-&gt;name, uc-&gt;protocol_whitelist);</span><br><span class="line">        <span class="keyword">return</span> AVERROR(EINVAL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uc-&gt;protocol_blacklist &amp;&amp; av_match_list(uc-&gt;prot-&gt;name, uc-&gt;protocol_blacklist, <span class="string">','</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        av_log(uc, AV_LOG_ERROR, <span class="string">"Protocol '%s' on blacklist '%s'!\n"</span>, uc-&gt;prot-&gt;name, uc-&gt;protocol_blacklist);</span><br><span class="line">        <span class="keyword">return</span> AVERROR(EINVAL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!uc-&gt;protocol_whitelist &amp;&amp; uc-&gt;prot-&gt;default_whitelist) &#123;</span><br><span class="line">        av_log(uc, AV_LOG_DEBUG, <span class="string">"Setting default whitelist '%s'\n"</span>, uc-&gt;prot-&gt;default_whitelist);</span><br><span class="line">        uc-&gt;protocol_whitelist = av_strdup(uc-&gt;prot-&gt;default_whitelist);</span><br><span class="line">        <span class="keyword">if</span> (!uc-&gt;protocol_whitelist) &#123;</span><br><span class="line">            <span class="keyword">return</span> AVERROR(ENOMEM);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!uc-&gt;protocol_whitelist)</span><br><span class="line">        av_log(uc, AV_LOG_DEBUG, <span class="string">"No default whitelist set\n"</span>); <span class="comment">// This should be an error once all declare a default whitelist</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = av_dict_set(options, <span class="string">"protocol_whitelist"</span>, uc-&gt;protocol_whitelist, <span class="number">0</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    <span class="keyword">if</span> ((err = av_dict_set(options, <span class="string">"protocol_blacklist"</span>, uc-&gt;protocol_blacklist, <span class="number">0</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    err =</span><br><span class="line">        <span class="comment">/// uc.prot ÊòØ http  url_open2 ÂØπÂ∫îÁöÑÊòØ http_open</span></span><br><span class="line">        uc-&gt;prot-&gt;url_open2 ? uc-&gt;prot-&gt;url_open2(uc,</span><br><span class="line">                                                  uc-&gt;filename,</span><br><span class="line">                                                  uc-&gt;flags,</span><br><span class="line">                                                  options) :</span><br><span class="line">        uc-&gt;prot-&gt;url_open(uc, uc-&gt;filename, uc-&gt;flags);</span><br><span class="line"></span><br><span class="line">    av_dict_set(options, <span class="string">"protocol_whitelist"</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    av_dict_set(options, <span class="string">"protocol_blacklist"</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    uc-&gt;is_connected = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* We must be careful here as ffurl_seek() could be slow,</span></span><br><span class="line"><span class="comment">     * for example for http */</span></span><br><span class="line">    <span class="keyword">if</span> ((uc-&gt;flags &amp; AVIO_FLAG_WRITE) || !<span class="built_in">strcmp</span>(uc-&gt;prot-&gt;name, <span class="string">"file"</span>))</span><br><span class="line">        <span class="keyword">if</span> (!uc-&gt;is_streamed &amp;&amp; ffurl_seek(uc, <span class="number">0</span>, SEEK_SET) &lt; <span class="number">0</span>)</span><br><span class="line">            uc-&gt;is_streamed = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">libavformat/aviobuf.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ffio_fdopen</span><span class="params">(AVIOContext **s, URLContext *h)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> *buffer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> buffer_size, max_packet_size;</span><br><span class="line"></span><br><span class="line">    max_packet_size = h-&gt;max_packet_size;</span><br><span class="line">    <span class="keyword">if</span> (max_packet_size) &#123;</span><br><span class="line">        buffer_size = max_packet_size; <span class="comment">/* no need to bufferize more than one packet */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        buffer_size = IO_BUFFER_SIZE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(h-&gt;flags &amp; AVIO_FLAG_WRITE) &amp;&amp; h-&gt;is_streamed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (buffer_size &gt; INT_MAX/<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">return</span> AVERROR(EINVAL);</span><br><span class="line">        buffer_size *= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    buffer = av_malloc(buffer_size);</span><br><span class="line">    <span class="keyword">if</span> (!buffer)</span><br><span class="line">        <span class="keyword">return</span> AVERROR(ENOMEM);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// ÂàõÂª∫ AVIOContext</span></span><br><span class="line">    <span class="comment">/// s-&gt;opaque = h;</span></span><br><span class="line">    *s = avio_alloc_context(buffer, buffer_size, h-&gt;flags &amp; AVIO_FLAG_WRITE, h,</span><br><span class="line">                            (<span class="keyword">int</span> (*)(<span class="keyword">void</span> *, <span class="keyword">uint8_t</span> *, <span class="keyword">int</span>))  ffurl_read,</span><br><span class="line">                            (<span class="keyword">int</span> (*)(<span class="keyword">void</span> *, <span class="keyword">uint8_t</span> *, <span class="keyword">int</span>))  ffurl_write,</span><br><span class="line">                            (<span class="keyword">int64_t</span> (*)(<span class="keyword">void</span> *, <span class="keyword">int64_t</span>, <span class="keyword">int</span>))ffurl_seek);</span><br><span class="line">    <span class="keyword">if</span> (!*s) &#123;</span><br><span class="line">        av_freep(&amp;buffer);</span><br><span class="line">        <span class="keyword">return</span> AVERROR(ENOMEM);</span><br><span class="line">    &#125;</span><br><span class="line">    (*s)-&gt;protocol_whitelist = av_strdup(h-&gt;protocol_whitelist);</span><br><span class="line">    <span class="keyword">if</span> (!(*s)-&gt;protocol_whitelist &amp;&amp; h-&gt;protocol_whitelist) &#123;</span><br><span class="line">        avio_closep(s);</span><br><span class="line">        <span class="keyword">return</span> AVERROR(ENOMEM);</span><br><span class="line">    &#125;</span><br><span class="line">    (*s)-&gt;protocol_blacklist = av_strdup(h-&gt;protocol_blacklist);</span><br><span class="line">    <span class="keyword">if</span> (!(*s)-&gt;protocol_blacklist &amp;&amp; h-&gt;protocol_blacklist) &#123;</span><br><span class="line">        avio_closep(s);</span><br><span class="line">        <span class="keyword">return</span> AVERROR(ENOMEM);</span><br><span class="line">    &#125;</span><br><span class="line">    (*s)-&gt;direct = h-&gt;flags &amp; AVIO_FLAG_DIRECT;</span><br><span class="line"></span><br><span class="line">    (*s)-&gt;seekable = h-&gt;is_streamed ? <span class="number">0</span> : AVIO_SEEKABLE_NORMAL;</span><br><span class="line">    (*s)-&gt;max_packet_size = max_packet_size;</span><br><span class="line">    (*s)-&gt;min_packet_size = h-&gt;min_packet_size;</span><br><span class="line">    <span class="keyword">if</span>(h-&gt;prot) &#123;</span><br><span class="line">        (*s)-&gt;read_pause = (<span class="keyword">int</span> (*)(<span class="keyword">void</span> *, <span class="keyword">int</span>))h-&gt;prot-&gt;url_read_pause;</span><br><span class="line">        (*s)-&gt;read_seek  =</span><br><span class="line">            (<span class="keyword">int64_t</span> (*)(<span class="keyword">void</span> *, <span class="keyword">int</span>, <span class="keyword">int64_t</span>, <span class="keyword">int</span>))h-&gt;prot-&gt;url_read_seek;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (h-&gt;prot-&gt;url_read_seek)</span><br><span class="line">            (*s)-&gt;seekable |= AVIO_SEEKABLE_TIME;</span><br><span class="line">    &#125;</span><br><span class="line">    ((FFIOContext*)(*s))-&gt;short_seek_get = (<span class="keyword">int</span> (*)(<span class="keyword">void</span> *))ffurl_get_short_seek;</span><br><span class="line">    (*s)-&gt;av_class = &amp;ff_avio_class;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br></pre></td><td class="code"><pre><span class="line">libavformat/http.c</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Ëøô‰∏™Â∞±ÊòØÂØπÂ∫îÂâçÈù¢ÁöÑ protocol</span></span><br><span class="line"><span class="keyword">const</span> URLProtocol ff_http_protocol = &#123;</span><br><span class="line">    .name                = <span class="string">"http"</span>,</span><br><span class="line">    <span class="comment">/// *</span></span><br><span class="line">    .url_open2           = http_open,  </span><br><span class="line">    .url_accept          = http_accept,</span><br><span class="line">    .url_handshake       = http_handshake,</span><br><span class="line">    .url_read            = http_read,</span><br><span class="line">    .url_write           = http_write,</span><br><span class="line">    .url_seek            = http_seek,</span><br><span class="line">    .url_close           = http_close,</span><br><span class="line">    .url_get_file_handle = http_get_file_handle,</span><br><span class="line">    .url_get_short_seek  = http_get_short_seek,</span><br><span class="line">    .url_shutdown        = http_shutdown,</span><br><span class="line">    <span class="comment">/// *</span></span><br><span class="line">    .priv_data_size      = <span class="keyword">sizeof</span>(HTTPContext),</span><br><span class="line">    .priv_data_class     = &amp;http_context_class,</span><br><span class="line">    .flags               = URL_PROTOCOL_FLAG_NETWORK,</span><br><span class="line">    .default_whitelist   = <span class="string">"http,https,tls,rtp,tcp,udp,crypto,httpproxy,data"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">http_open</span><span class="params">(URLContext *h, <span class="keyword">const</span> <span class="keyword">char</span> *uri, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">                     AVDictionary **options)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HTTPContext *s = h-&gt;priv_data;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( s-&gt;seekable == <span class="number">1</span> )</span><br><span class="line">        h-&gt;is_streamed = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        h-&gt;is_streamed = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    s-&gt;filesize = UINT64_MAX;</span><br><span class="line"></span><br><span class="line">    s-&gt;location = av_strdup(uri);</span><br><span class="line">    <span class="keyword">if</span> (!s-&gt;location)</span><br><span class="line">        <span class="keyword">return</span> AVERROR(ENOMEM);</span><br><span class="line"></span><br><span class="line">    s-&gt;uri = av_strdup(uri);</span><br><span class="line">    <span class="keyword">if</span> (!s-&gt;uri)</span><br><span class="line">        <span class="keyword">return</span> AVERROR(ENOMEM);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options)</span><br><span class="line">        av_dict_copy(&amp;s-&gt;chained_options, *options, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;headers) &#123;</span><br><span class="line">        <span class="keyword">int</span> len = <span class="built_in">strlen</span>(s-&gt;headers);</span><br><span class="line">        <span class="keyword">if</span> (len &lt; <span class="number">2</span> || <span class="built_in">strcmp</span>(<span class="string">"\r\n"</span>, s-&gt;headers + len - <span class="number">2</span>)) &#123;</span><br><span class="line">            av_log(h, AV_LOG_WARNING,</span><br><span class="line">                   <span class="string">"No trailing CRLF found in HTTP header. Adding it.\n"</span>);</span><br><span class="line">            ret = av_reallocp(&amp;s-&gt;headers, len + <span class="number">3</span>);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> bail_out;</span><br><span class="line">            s-&gt;headers[len]     = <span class="string">'\r'</span>;</span><br><span class="line">            s-&gt;headers[len + <span class="number">1</span>] = <span class="string">'\n'</span>;</span><br><span class="line">            s-&gt;headers[len + <span class="number">2</span>] = <span class="string">'\0'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;listen) &#123;</span><br><span class="line">        <span class="keyword">return</span> http_listen(h, uri, flags, options);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// ËøõËøôÈáå</span></span><br><span class="line">    ret = http_open_cnx(h, options);</span><br><span class="line">bail_out:</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        av_dict_free(&amp;s-&gt;chained_options);</span><br><span class="line">        av_dict_free(&amp;s-&gt;cookie_dict);</span><br><span class="line">        av_dict_free(&amp;s-&gt;redirect_cache);</span><br><span class="line">        av_freep(&amp;s-&gt;new_location);</span><br><span class="line">        av_freep(&amp;s-&gt;uri);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">http_open_cnx</span><span class="params">(URLContext *h, AVDictionary **options)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HTTPAuthType cur_auth_type, cur_proxy_auth_type;</span><br><span class="line">    HTTPContext *s = h-&gt;priv_data;</span><br><span class="line">    <span class="keyword">int</span> ret, attempts = <span class="number">0</span>, redirects = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> reconnect_delay = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> off;</span><br><span class="line">    <span class="keyword">char</span> *cached;</span><br><span class="line"></span><br><span class="line">redo:</span><br><span class="line"></span><br><span class="line">    cached = redirect_cache_get(s);</span><br><span class="line">    <span class="keyword">if</span> (cached) &#123;</span><br><span class="line">        av_free(s-&gt;location);</span><br><span class="line">        s-&gt;location = av_strdup(cached);</span><br><span class="line">        <span class="keyword">if</span> (!s-&gt;location) &#123;</span><br><span class="line">            ret = AVERROR(ENOMEM);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> redo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    av_dict_copy(options, s-&gt;chained_options, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    cur_auth_type       = s-&gt;auth_state.auth_type;</span><br><span class="line">    cur_proxy_auth_type = s-&gt;auth_state.auth_type;</span><br><span class="line"></span><br><span class="line">    off = s-&gt;off;</span><br><span class="line">    <span class="comment">/// ËøõËøôÈáå ÂÖ≥ÈîÆÊñπÊ≥ï</span></span><br><span class="line">    ret = http_open_cnx_internal(h, options);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!http_should_reconnect(s, ret) ||</span><br><span class="line">            reconnect_delay &gt; s-&gt;reconnect_delay_max)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">        av_log(h, AV_LOG_WARNING, <span class="string">"Will reconnect at %"</span>PRIu64<span class="string">" in %d second(s).\n"</span>, off, reconnect_delay);</span><br><span class="line">        ret = ff_network_sleep_interruptible(<span class="number">1000U</span> * <span class="number">1000</span> * reconnect_delay, &amp;h-&gt;interrupt_callback);</span><br><span class="line">        <span class="keyword">if</span> (ret != AVERROR(ETIMEDOUT))</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        reconnect_delay = <span class="number">1</span> + <span class="number">2</span> * reconnect_delay;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* restore the offset (http_connect resets it) */</span></span><br><span class="line">        s-&gt;off = off;</span><br><span class="line"></span><br><span class="line">        ffurl_closep(&amp;s-&gt;hd);</span><br><span class="line">        <span class="keyword">goto</span> redo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    attempts++;</span><br><span class="line">    <span class="keyword">if</span> (s-&gt;http_code == <span class="number">401</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((cur_auth_type == HTTP_AUTH_NONE || s-&gt;auth_state.stale) &amp;&amp;</span><br><span class="line">            s-&gt;auth_state.auth_type != HTTP_AUTH_NONE &amp;&amp; attempts &lt; <span class="number">4</span>) &#123;</span><br><span class="line">            ffurl_closep(&amp;s-&gt;hd);</span><br><span class="line">            <span class="keyword">goto</span> redo;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s-&gt;http_code == <span class="number">407</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((cur_proxy_auth_type == HTTP_AUTH_NONE || s-&gt;proxy_auth_state.stale) &amp;&amp;</span><br><span class="line">            s-&gt;proxy_auth_state.auth_type != HTTP_AUTH_NONE &amp;&amp; attempts &lt; <span class="number">4</span>) &#123;</span><br><span class="line">            ffurl_closep(&amp;s-&gt;hd);</span><br><span class="line">            <span class="keyword">goto</span> redo;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((s-&gt;http_code == <span class="number">301</span> || s-&gt;http_code == <span class="number">302</span> ||</span><br><span class="line">         s-&gt;http_code == <span class="number">303</span> || s-&gt;http_code == <span class="number">307</span> || s-&gt;http_code == <span class="number">308</span>) &amp;&amp;</span><br><span class="line">        s-&gt;new_location) &#123;</span><br><span class="line">        <span class="comment">/* url moved, get next */</span></span><br><span class="line">        ffurl_closep(&amp;s-&gt;hd);</span><br><span class="line">        <span class="keyword">if</span> (redirects++ &gt;= MAX_REDIRECTS)</span><br><span class="line">            <span class="keyword">return</span> AVERROR(EIO);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!s-&gt;expires) &#123;</span><br><span class="line">            s-&gt;expires = (s-&gt;http_code == <span class="number">301</span> || s-&gt;http_code == <span class="number">308</span>) ? INT64_MAX : <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (s-&gt;expires &gt; time(<span class="literal">NULL</span>) &amp;&amp; av_dict_count(s-&gt;redirect_cache) &lt; MAX_CACHED_REDIRECTS) &#123;</span><br><span class="line">            redirect_cache_set(s, s-&gt;location, s-&gt;new_location, s-&gt;expires);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        av_free(s-&gt;location);</span><br><span class="line">        s-&gt;location = s-&gt;new_location;</span><br><span class="line">        s-&gt;new_location = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Restart the authentication process with the new target, which</span></span><br><span class="line"><span class="comment">         * might use a different auth mechanism. */</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp;s-&gt;auth_state, <span class="number">0</span>, <span class="keyword">sizeof</span>(s-&gt;auth_state));</span><br><span class="line">        attempts         = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> redo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">    <span class="keyword">if</span> (s-&gt;hd)</span><br><span class="line">        ffurl_closep(&amp;s-&gt;hd);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    <span class="keyword">return</span> ff_http_averror(s-&gt;http_code, AVERROR(EIO));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">http_open_cnx_internal</span><span class="params">(URLContext *h, AVDictionary **options)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/// lower_proto ÂÖ≥ÈîÆ</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path, *proxy_path, *lower_proto = <span class="string">"tcp"</span>, *local_path;</span><br><span class="line">    <span class="keyword">char</span> *env_http_proxy, *env_no_proxy;</span><br><span class="line">    <span class="keyword">char</span> *hashmark;</span><br><span class="line">    <span class="keyword">char</span> hostname[<span class="number">1024</span>], hoststr[<span class="number">1024</span>], proto[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">char</span> auth[<span class="number">1024</span>], proxyauth[<span class="number">1024</span>] = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">char</span> path1[MAX_URL_SIZE], sanitized_path[MAX_URL_SIZE + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>], urlbuf[MAX_URL_SIZE];</span><br><span class="line">    <span class="keyword">int</span> port, use_proxy, err = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/// ÂâçÈù¢ÂÆö‰πâhttpprotocalÁöÑÊó∂ÂÄôËÆæÁΩÆËøá‰∫Ü</span></span><br><span class="line">    HTTPContext *s = h-&gt;priv_data;</span><br><span class="line"></span><br><span class="line">    av_url_split(proto, <span class="keyword">sizeof</span>(proto), auth, <span class="keyword">sizeof</span>(auth),</span><br><span class="line">                 hostname, <span class="keyword">sizeof</span>(hostname), &amp;port,</span><br><span class="line">                 path1, <span class="keyword">sizeof</span>(path1), s-&gt;location);</span><br><span class="line">    ff_url_join(hoststr, <span class="keyword">sizeof</span>(hoststr), <span class="literal">NULL</span>, <span class="literal">NULL</span>, hostname, port, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    env_http_proxy = getenv_utf8(<span class="string">"http_proxy"</span>);</span><br><span class="line">    proxy_path = s-&gt;http_proxy ? s-&gt;http_proxy : env_http_proxy;</span><br><span class="line"></span><br><span class="line">    env_no_proxy = getenv_utf8(<span class="string">"no_proxy"</span>);</span><br><span class="line">    use_proxy  = !ff_http_match_no_proxy(env_no_proxy, hostname) &amp;&amp;</span><br><span class="line">                 proxy_path &amp;&amp; av_strstart(proxy_path, <span class="string">"http://"</span>, <span class="literal">NULL</span>);</span><br><span class="line">    freeenv_utf8(env_no_proxy);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Â¶ÇÊûúÊòØhttps ‰ºöËµ∞Âà∞ tls (tls_securetransport.c &amp; tls.c)</span></span><br><span class="line">    <span class="comment">/// tls ÂÜÖÈÉ® ÊúÄÂêé‰πü‰ºöËµ∞Âà∞tcpÁöÑ  ÂÖàÁï•Ëøá ÂÖàÁõ¥Êé•Áúãtcp</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(proto, <span class="string">"https"</span>)) &#123;</span><br><span class="line">        lower_proto = <span class="string">"tls"</span>;</span><br><span class="line">        use_proxy   = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (port &lt; <span class="number">0</span>)</span><br><span class="line">            port = <span class="number">443</span>;</span><br><span class="line">        <span class="comment">/* pass http_proxy to underlying protocol */</span></span><br><span class="line">        <span class="keyword">if</span> (s-&gt;http_proxy) &#123;</span><br><span class="line">            err = av_dict_set(options, <span class="string">"http_proxy"</span>, s-&gt;http_proxy, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> end;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (port &lt; <span class="number">0</span>)</span><br><span class="line">        port = <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">    hashmark = <span class="built_in">strchr</span>(path1, <span class="string">'#'</span>);</span><br><span class="line">    <span class="keyword">if</span> (hashmark)</span><br><span class="line">        *hashmark = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (path1[<span class="number">0</span>] == <span class="string">'\0'</span>) &#123;</span><br><span class="line">        path = <span class="string">"/"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path1[<span class="number">0</span>] == <span class="string">'?'</span>) &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(sanitized_path, <span class="keyword">sizeof</span>(sanitized_path), <span class="string">"/%s"</span>, path1);</span><br><span class="line">        path = sanitized_path;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        path = path1;</span><br><span class="line">    &#125;</span><br><span class="line">    local_path = path;</span><br><span class="line">    <span class="keyword">if</span> (use_proxy) &#123;</span><br><span class="line">        <span class="comment">/* Reassemble the request URL without auth string - we don't</span></span><br><span class="line"><span class="comment">         * want to leak the auth to the proxy. */</span></span><br><span class="line">        ff_url_join(urlbuf, <span class="keyword">sizeof</span>(urlbuf), proto, <span class="literal">NULL</span>, hostname, port, <span class="string">"%s"</span>,</span><br><span class="line">                    path1);</span><br><span class="line">        path = urlbuf;</span><br><span class="line">        av_url_split(<span class="literal">NULL</span>, <span class="number">0</span>, proxyauth, <span class="keyword">sizeof</span>(proxyauth),</span><br><span class="line">                     hostname, <span class="keyword">sizeof</span>(hostname), &amp;port, <span class="literal">NULL</span>, <span class="number">0</span>, proxy_path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// ËøôÈáåÂÖà‰ª•tcpÊù•ÂàÜÊûê</span></span><br><span class="line">    ff_url_join(buf, <span class="keyword">sizeof</span>(buf), lower_proto, <span class="literal">NULL</span>, hostname, port, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!s-&gt;hd) &#123;</span><br><span class="line">        <span class="comment">/// s-&gt;hd ‰πüÊòØ URLContextÔºåÂèëÁé∞ËøôÈáåÂèàËøõÂÖ•‰∫Üffurl_open_whitelist Âæ™ÁéØ‰∫Ü  </span></span><br><span class="line">        <span class="comment">/// buf ÊòØ tcp‰∫Ü ‰∏çÊòØhttp ‰∫ÜÔºå Âê¶ÂàôÂ∞±Ë∑≥‰∏çÂá∫Êù•‰∫Ü</span></span><br><span class="line">        <span class="comment">/// ÊâÄ‰ª• s-&gt;hd ÁöÑ protocal ÊòØ TCPProtocol</span></span><br><span class="line">        err = ffurl_open_whitelist(&amp;s-&gt;hd, buf, AVIO_FLAG_READ_WRITE,</span><br><span class="line">                                   &amp;h-&gt;interrupt_callback, options,</span><br><span class="line">                                   h-&gt;protocol_whitelist, h-&gt;protocol_blacklist, h);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">end:</span><br><span class="line">    freeenv_utf8(env_http_proxy);</span><br><span class="line">    <span class="keyword">return</span> err &lt; <span class="number">0</span> ? err : http_connect(</span><br><span class="line">        h, path, local_path, hoststr, auth, proxyauth);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">http_connect</span><span class="params">(URLContext *h, <span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *local_path,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> <span class="keyword">char</span> *hoststr, <span class="keyword">const</span> <span class="keyword">char</span> *auth,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> <span class="keyword">char</span> *proxyauth)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HTTPContext *s = h-&gt;priv_data;</span><br><span class="line">    <span class="keyword">int</span> post, err;</span><br><span class="line">    AVBPrint request;</span><br><span class="line">    <span class="keyword">char</span> *authstr = <span class="literal">NULL</span>, *proxyauthstr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> off = s-&gt;off;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *method;</span><br><span class="line">    <span class="keyword">int</span> send_expect_100 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    av_bprint_init_for_buffer(&amp;request, s-&gt;buffer, <span class="keyword">sizeof</span>(s-&gt;buffer));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* send http header */</span></span><br><span class="line">    post = h-&gt;flags &amp; AVIO_FLAG_WRITE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;post_data) &#123;</span><br><span class="line">        <span class="comment">/* force POST method and disable chunked encoding when</span></span><br><span class="line"><span class="comment">         * custom HTTP post data is set */</span></span><br><span class="line">        post            = <span class="number">1</span>;</span><br><span class="line">        s-&gt;chunked_post = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;method)</span><br><span class="line">        method = s-&gt;method;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        method = post ? <span class="string">"POST"</span> : <span class="string">"GET"</span>;</span><br><span class="line"></span><br><span class="line">    authstr      = ff_http_auth_create_response(&amp;s-&gt;auth_state, auth,</span><br><span class="line">                                                local_path, method);</span><br><span class="line">    proxyauthstr = ff_http_auth_create_response(&amp;s-&gt;proxy_auth_state, proxyauth,</span><br><span class="line">                                                local_path, method);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (post &amp;&amp; !s-&gt;post_data) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s-&gt;send_expect_100 != <span class="number">-1</span>) &#123;</span><br><span class="line">            send_expect_100 = s-&gt;send_expect_100;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            send_expect_100 = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">/* The user has supplied authentication but we don't know the auth type,</span></span><br><span class="line"><span class="comment">             * send Expect: 100-continue to get the 401 response including the</span></span><br><span class="line"><span class="comment">             * WWW-Authenticate header, or an 100 continue if no auth actually</span></span><br><span class="line"><span class="comment">             * is needed. */</span></span><br><span class="line">            <span class="keyword">if</span> (auth &amp;&amp; *auth &amp;&amp;</span><br><span class="line">                s-&gt;auth_state.auth_type == HTTP_AUTH_NONE &amp;&amp;</span><br><span class="line">                s-&gt;http_code != <span class="number">401</span>)</span><br><span class="line">                send_expect_100 = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    av_bprintf(&amp;request, <span class="string">"%s "</span>, method);</span><br><span class="line">    bprint_escaped_path(&amp;request, path);</span><br><span class="line">    av_bprintf(&amp;request, <span class="string">" HTTP/1.1\r\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (post &amp;&amp; s-&gt;chunked_post)</span><br><span class="line">        av_bprintf(&amp;request, <span class="string">"Transfer-Encoding: chunked\r\n"</span>);</span><br><span class="line">    <span class="comment">/* set default headers if needed */</span></span><br><span class="line">    <span class="keyword">if</span> (!has_header(s-&gt;headers, <span class="string">"\r\nUser-Agent: "</span>))</span><br><span class="line">        av_bprintf(&amp;request, <span class="string">"User-Agent: %s\r\n"</span>, s-&gt;user_agent);</span><br><span class="line">    <span class="keyword">if</span> (s-&gt;referer) &#123;</span><br><span class="line">        <span class="comment">/* set default headers if needed */</span></span><br><span class="line">        <span class="keyword">if</span> (!has_header(s-&gt;headers, <span class="string">"\r\nReferer: "</span>))</span><br><span class="line">            av_bprintf(&amp;request, <span class="string">"Referer: %s\r\n"</span>, s-&gt;referer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!has_header(s-&gt;headers, <span class="string">"\r\nAccept: "</span>))</span><br><span class="line">        av_bprintf(&amp;request, <span class="string">"Accept: */*\r\n"</span>);</span><br><span class="line">    <span class="comment">// Note: we send the Range header on purpose, even when we're probing,</span></span><br><span class="line">    <span class="comment">// since it allows us to detect more reliably if a (non-conforming)</span></span><br><span class="line">    <span class="comment">// server supports seeking by analysing the reply headers.</span></span><br><span class="line">    <span class="keyword">if</span> (!has_header(s-&gt;headers, <span class="string">"\r\nRange: "</span>) &amp;&amp; !post &amp;&amp; (s-&gt;off &gt; <span class="number">0</span> || s-&gt;end_off || s-&gt;seekable != <span class="number">0</span>)) &#123;</span><br><span class="line">        av_bprintf(&amp;request, <span class="string">"Range: bytes=%"</span>PRIu64<span class="string">"-"</span>, s-&gt;off);</span><br><span class="line">        <span class="keyword">if</span> (s-&gt;end_off)</span><br><span class="line">            av_bprintf(&amp;request, <span class="string">"%"</span>PRId64, s-&gt;end_off - <span class="number">1</span>);</span><br><span class="line">        av_bprintf(&amp;request, <span class="string">"\r\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (send_expect_100 &amp;&amp; !has_header(s-&gt;headers, <span class="string">"\r\nExpect: "</span>))</span><br><span class="line">        av_bprintf(&amp;request, <span class="string">"Expect: 100-continue\r\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!has_header(s-&gt;headers, <span class="string">"\r\nConnection: "</span>))</span><br><span class="line">        av_bprintf(&amp;request, <span class="string">"Connection: %s\r\n"</span>, s-&gt;multiple_requests ? <span class="string">"keep-alive"</span> : <span class="string">"close"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!has_header(s-&gt;headers, <span class="string">"\r\nHost: "</span>))</span><br><span class="line">        av_bprintf(&amp;request, <span class="string">"Host: %s\r\n"</span>, hoststr);</span><br><span class="line">    <span class="keyword">if</span> (!has_header(s-&gt;headers, <span class="string">"\r\nContent-Length: "</span>) &amp;&amp; s-&gt;post_data)</span><br><span class="line">        av_bprintf(&amp;request, <span class="string">"Content-Length: %d\r\n"</span>, s-&gt;post_datalen);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!has_header(s-&gt;headers, <span class="string">"\r\nContent-Type: "</span>) &amp;&amp; s-&gt;content_type)</span><br><span class="line">        av_bprintf(&amp;request, <span class="string">"Content-Type: %s\r\n"</span>, s-&gt;content_type);</span><br><span class="line">    <span class="keyword">if</span> (!has_header(s-&gt;headers, <span class="string">"\r\nCookie: "</span>) &amp;&amp; s-&gt;cookies) &#123;</span><br><span class="line">        <span class="keyword">char</span> *cookies = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (!get_cookies(s, &amp;cookies, path, hoststr) &amp;&amp; cookies) &#123;</span><br><span class="line">            av_bprintf(&amp;request, <span class="string">"Cookie: %s\r\n"</span>, cookies);</span><br><span class="line">            av_free(cookies);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!has_header(s-&gt;headers, <span class="string">"\r\nIcy-MetaData: "</span>) &amp;&amp; s-&gt;icy)</span><br><span class="line">        av_bprintf(&amp;request, <span class="string">"Icy-MetaData: 1\r\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* now add in custom headers */</span></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;headers)</span><br><span class="line">        av_bprintf(&amp;request, <span class="string">"%s"</span>, s-&gt;headers);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (authstr)</span><br><span class="line">        av_bprintf(&amp;request, <span class="string">"%s"</span>, authstr);</span><br><span class="line">    <span class="keyword">if</span> (proxyauthstr)</span><br><span class="line">        av_bprintf(&amp;request, <span class="string">"Proxy-%s"</span>, proxyauthstr);</span><br><span class="line">    av_bprintf(&amp;request, <span class="string">"\r\n"</span>);</span><br><span class="line"></span><br><span class="line">    av_log(h, AV_LOG_DEBUG, <span class="string">"request: %s\n"</span>, request.str);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!av_bprint_is_complete(&amp;request)) &#123;</span><br><span class="line">        av_log(h, AV_LOG_ERROR, <span class="string">"overlong headers\n"</span>);</span><br><span class="line">        err = AVERROR(EINVAL);</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// ÂÜôÂÖ•Êï∞ÊçÆ ÂèëËµ∑ËØ∑Ê±Ç</span></span><br><span class="line">    <span class="keyword">if</span> ((err = ffurl_write(s-&gt;hd, request.str, request.len)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;post_data)</span><br><span class="line">        <span class="keyword">if</span> ((err = ffurl_write(s-&gt;hd, s-&gt;post_data, s-&gt;post_datalen)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* init input buffer */</span></span><br><span class="line">    s-&gt;buf_ptr          = s-&gt;buffer;</span><br><span class="line">    s-&gt;buf_end          = s-&gt;buffer;</span><br><span class="line">    s-&gt;line_count       = <span class="number">0</span>;</span><br><span class="line">    s-&gt;off              = <span class="number">0</span>;</span><br><span class="line">    s-&gt;icy_data_read    = <span class="number">0</span>;</span><br><span class="line">    s-&gt;filesize         = UINT64_MAX;</span><br><span class="line">    s-&gt;willclose        = <span class="number">0</span>;</span><br><span class="line">    s-&gt;end_chunked_post = <span class="number">0</span>;</span><br><span class="line">    s-&gt;end_header       = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_ZLIB</span></span><br><span class="line">    s-&gt;compressed       = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (post &amp;&amp; !s-&gt;post_data &amp;&amp; !send_expect_100) &#123;</span><br><span class="line">        <span class="comment">/* Pretend that it did work. We didn't read any header yet, since</span></span><br><span class="line"><span class="comment">         * we've still to send the POST data, but the code calling this</span></span><br><span class="line"><span class="comment">         * function will check http_code after we return. */</span></span><br><span class="line">        s-&gt;http_code = <span class="number">200</span>;</span><br><span class="line">        err = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* wait for header */</span></span><br><span class="line">    err = http_read_header(h);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;new_location)</span><br><span class="line">        s-&gt;off = off;</span><br><span class="line"></span><br><span class="line">    err = (off == s-&gt;off) ? <span class="number">0</span> : <span class="number">-1</span>;</span><br><span class="line">done:</span><br><span class="line">    av_freep(&amp;authstr);</span><br><span class="line">    av_freep(&amp;proxyauthstr);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">libavformat/avio.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ffurl_write</span><span class="params">(URLContext *h, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(h-&gt;flags &amp; AVIO_FLAG_WRITE))</span><br><span class="line">        <span class="keyword">return</span> AVERROR(EIO);</span><br><span class="line">    <span class="comment">/* avoid sending too big packets */</span></span><br><span class="line">    <span class="keyword">if</span> (h-&gt;max_packet_size &amp;&amp; size &gt; h-&gt;max_packet_size)</span><br><span class="line">        <span class="keyword">return</span> AVERROR(EIO);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// h-&gt;prot ÈÄöËøáÂâçÈù¢ÁöÑÂàÜÊûê Â∞±ÊòØTCPProtocol</span></span><br><span class="line">    <span class="keyword">return</span> retry_transfer_wrapper(h, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)buf, size, size,</span><br><span class="line">                                  (<span class="keyword">int</span> (*)(struct URLContext *, <span class="keyword">uint8_t</span> *, <span class="keyword">int</span>))</span><br><span class="line">                                  h-&gt;prot-&gt;url_write);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">retry_transfer_wrapper</span><span class="params">(URLContext *h, <span class="keyword">uint8_t</span> *buf,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         <span class="keyword">int</span> size, <span class="keyword">int</span> size_min,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         <span class="keyword">int</span> (*transfer_func)(URLContext *h,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                              <span class="keyword">uint8_t</span> *buf,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                              <span class="keyword">int</span> size))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret, len;</span><br><span class="line">    <span class="keyword">int</span> fast_retries = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int64_t</span> wait_since = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (len &lt; size_min) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ff_check_interrupt(&amp;h-&gt;interrupt_callback))</span><br><span class="line">            <span class="keyword">return</span> AVERROR_EXIT;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// ÂõûË∞É           </span></span><br><span class="line">        ret = transfer_func(h, buf + len, size - len);</span><br><span class="line">        <span class="keyword">if</span> (ret == AVERROR(EINTR))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (h-&gt;flags &amp; AVIO_FLAG_NONBLOCK)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        <span class="keyword">if</span> (ret == AVERROR(EAGAIN)) &#123;</span><br><span class="line">            ret = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (fast_retries) &#123;</span><br><span class="line">                fast_retries--;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (h-&gt;rw_timeout) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!wait_since)</span><br><span class="line">                        wait_since = av_gettime_relative();</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (av_gettime_relative() &gt; wait_since + h-&gt;rw_timeout)</span><br><span class="line">                        <span class="keyword">return</span> AVERROR(EIO);</span><br><span class="line">                &#125;</span><br><span class="line">                av_usleep(<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == AVERROR_EOF)</span><br><span class="line">            <span class="keyword">return</span> (len &gt; <span class="number">0</span>) ? len : AVERROR_EOF;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            fast_retries = FFMAX(fast_retries, <span class="number">2</span>);</span><br><span class="line">            wait_since = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        len += ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">libavformat/tcp.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> URLProtocol ff_tcp_protocol = &#123;</span><br><span class="line">    .name                = <span class="string">"tcp"</span>,</span><br><span class="line">    .url_open            = tcp_open,</span><br><span class="line">    .url_accept          = tcp_accept,</span><br><span class="line">    .url_read            = tcp_read,</span><br><span class="line">    .url_write           = tcp_write,</span><br><span class="line">    .url_close           = tcp_close,</span><br><span class="line">    .url_get_file_handle = tcp_get_file_handle,</span><br><span class="line">    .url_get_short_seek  = tcp_get_window_size,</span><br><span class="line">    .url_shutdown        = tcp_shutdown,</span><br><span class="line">    .priv_data_size      = <span class="keyword">sizeof</span>(TCPContext),</span><br><span class="line">    .flags               = URL_PROTOCOL_FLAG_NETWORK,</span><br><span class="line">    .priv_data_class     = &amp;tcp_class,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tcp_write</span><span class="params">(URLContext *h, <span class="keyword">const</span> <span class="keyword">uint8_t</span> *buf, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TCPContext *s = h-&gt;priv_data;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(h-&gt;flags &amp; AVIO_FLAG_NONBLOCK)) &#123;</span><br><span class="line">        ret = ff_network_wait_fd_timeout(s-&gt;fd, <span class="number">1</span>, h-&gt;rw_timeout, &amp;h-&gt;interrupt_callback);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// socket send</span></span><br><span class="line">    ret = send(s-&gt;fd, buf, size, MSG_NOSIGNAL);</span><br><span class="line">    <span class="keyword">return</span> ret &lt; <span class="number">0</span> ? ff_neterrno() : ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Êï¥‰ΩìÁöÑ‰ª£Á†ÅÊµÅÁ®ãÂ¶Ç‰∏äÔºåÂÖ≥ÈîÆÂÖ•Âè£ÈÉΩÂú®ÂØπÂ∫îÁöÑÂú∞ÊñπÂä†‰∫ÜÊ≥®Èáä</strong></p>
<h3 id="class-relation"><a href="#class-relation" class="headerlink" title="class relation"></a>class relation</h3><p>avformat ÂàùÂßãÂåñ Ê†πÊçÆ urlÂçèËÆÆÊâæÂà∞ urlprotocolÔºå ÂàõÂª∫urlcontext &amp; aviocontext</p>
<p>‰∏âËÄÖÁöÑÂÖ≥Á≥ªÂ¶Ç‰∏ã</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">avformatcontext.pb = aviocontext</span><br><span class="line">aviocontext.opaque = urlcontext</span><br><span class="line">urlcontext.prot = urlprotocol</span><br></pre></td></tr></table></figure>
<p>urlprotocol privdata ÊåáÂÆö‰∏∫ httpcontext<br>httpcontext ÂÜÖÈÉ®ÊåÅÊúâÁöÑurlcontext Ê†πÊçÆ tcp ÊâæÂà∞tcpprotocol<br><code>httpconext.hd = urlcontext</code></p>
<p>ÂêéÁª≠ËøõÂÖ•Âà∞ tcp ÂèëÈÄÅÊï∞ÊçÆÁöÑÊµÅÁ®ã</p>
<h3 id="SSL-TLS"><a href="#SSL-TLS" class="headerlink" title="SSL/TLS"></a>SSL/TLS</h3><p>‰∏äÈù¢‰∏∫‰∫ÜÂø´ÈÄüÂºÑÊ∏ÖÊ•öË∞ÉÁî®ËøáÁ®ãÔºåÂΩìÂÅöhttpÂ§ÑÁêÜÔºåÁÆÄÂåñ‰∫ÜtlsËøô‰∏ÄÂùóÔºåhttpsÊó©Â∑≤ÊôÆÂèäÔºåÊâÄ‰ª•https Ë∑ü tcp ‰∏≠Èó¥Êúâ‰∏ÄÂ±Ç ssl/tls</p>
<p>ffmpeg ÂÜÖÈÉ®Â§ÑÁêÜtlsÂçèËÆÆÁöÑÊúâÂ•ΩÂá†‰∏™ <code>gnutls openssl schannel securetransport libtls mbedtls</code><br>Ê†πÊçÆ‰∏çÁî®ÁöÑÂπ≥Âè∞‰øùÁïôÂØπÂ∫îÁöÑÂì™‰∏Ä‰∏™ÔºåÊàëÁöÑËÆæÂ§áÊòØmacÔºåÂØπÂ∫îÁöÑÊòØ securetransport</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line">libavformat/tls_securetransport.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> URLProtocol ff_tls_protocol = &#123;</span><br><span class="line">    .name           = <span class="string">"tls"</span>,</span><br><span class="line">    .url_open2      = tls_open,</span><br><span class="line">    .url_read       = tls_read,</span><br><span class="line">    .url_write      = tls_write,</span><br><span class="line">    .url_close      = tls_close,</span><br><span class="line">    .url_get_file_handle = tls_get_file_handle,</span><br><span class="line">    .url_get_short_seek  = tls_get_short_seek,</span><br><span class="line">    .priv_data_size = <span class="keyword">sizeof</span>(TLSContext),</span><br><span class="line">    .flags          = URL_PROTOCOL_FLAG_NETWORK,</span><br><span class="line">    .priv_data_class = &amp;tls_class,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">TLSContext</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> AVClass *<span class="class"><span class="keyword">class</span>;</span></span><br><span class="line">    TLSShared tls_shared;</span><br><span class="line">    SSLContextRef ssl_context;</span><br><span class="line">    CFArrayRef ca_array;</span><br><span class="line">    <span class="keyword">int</span> lastErr;</span><br><span class="line">&#125; TLSContext;</span><br><span class="line"></span><br><span class="line">libavformat/tls.h</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">TLSShared</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *ca_file;</span><br><span class="line">    <span class="keyword">int</span> verify;</span><br><span class="line">    <span class="keyword">char</span> *cert_file;</span><br><span class="line">    <span class="keyword">char</span> *key_file;</span><br><span class="line">    <span class="keyword">int</span> listen;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *host;</span><br><span class="line">    <span class="keyword">char</span> *http_proxy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> underlying_host[<span class="number">200</span>];</span><br><span class="line">    <span class="keyword">int</span> numerichost;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// tlsÂÜÖÈÉ®Â∞±ÊòØtcp</span></span><br><span class="line">    URLContext *tcp;</span><br><span class="line">&#125; TLSShared;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tls_open</span><span class="params">(URLContext *h, <span class="keyword">const</span> <span class="keyword">char</span> *uri, <span class="keyword">int</span> flags, AVDictionary **options)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TLSContext *c = h-&gt;priv_data;</span><br><span class="line">    TLSShared *s = &amp;c-&gt;tls_shared;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// tcp open</span></span><br><span class="line">    <span class="keyword">if</span> ((ret = ff_tls_open_underlying(s, h, uri, options)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// sslcontext ÂàõÂª∫ËøáÁ®ã ËßÅÂ∫ïÈÉ®ÂºïÁî®ÁöÑËãπÊûúÊñáÊ°£</span></span><br><span class="line">    c-&gt;ssl_context = SSLCreateContext(<span class="literal">NULL</span>, s-&gt;listen ? kSSLServerSide : kSSLClientSide, kSSLStreamType);</span><br><span class="line">    <span class="keyword">if</span> (!c-&gt;ssl_context) &#123;</span><br><span class="line">        av_log(h, AV_LOG_ERROR, <span class="string">"Unable to create SSL context\n"</span>);</span><br><span class="line">        ret = AVERROR(ENOMEM);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s-&gt;ca_file) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((ret = load_ca(h)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s-&gt;ca_file || !s-&gt;verify)</span><br><span class="line">        CHECK_ERROR(SSLSetSessionOption, c-&gt;ssl_context, kSSLSessionOptionBreakOnServerAuth, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (s-&gt;cert_file)</span><br><span class="line">        <span class="keyword">if</span> ((ret = load_cert(h)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">    CHECK_ERROR(SSLSetPeerDomainName, c-&gt;ssl_context, s-&gt;host, <span class="built_in">strlen</span>(s-&gt;host));</span><br><span class="line">    <span class="comment">/// io ÂõûË∞É</span></span><br><span class="line">    CHECK_ERROR(SSLSetIOFuncs, c-&gt;ssl_context, tls_read_cb, tls_write_cb);</span><br><span class="line">    CHECK_ERROR(SSLSetConnection, c-&gt;ssl_context, h);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        OSStatus status = SSLHandshake(c-&gt;ssl_context);</span><br><span class="line">        <span class="keyword">if</span> (status == errSSLServerAuthCompleted) &#123;</span><br><span class="line">            SecTrustRef peerTrust;</span><br><span class="line">            SecTrustResultType trustResult;</span><br><span class="line">            <span class="keyword">if</span> (!s-&gt;verify)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (SSLCopyPeerTrust(c-&gt;ssl_context, &amp;peerTrust) != noErr) &#123;</span><br><span class="line">                ret = AVERROR(ENOMEM);</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (SecTrustSetAnchorCertificates(peerTrust, c-&gt;ca_array) != noErr) &#123;</span><br><span class="line">                ret = AVERROR_UNKNOWN;</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (SecTrustEvaluate(peerTrust, &amp;trustResult) != noErr) &#123;</span><br><span class="line">                ret = AVERROR_UNKNOWN;</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (trustResult == kSecTrustResultProceed ||</span><br><span class="line">                trustResult == kSecTrustResultUnspecified) &#123;</span><br><span class="line">                <span class="comment">// certificate is trusted</span></span><br><span class="line">                status = errSSLWouldBlock; <span class="comment">// so we call SSLHandshake again</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (trustResult == kSecTrustResultRecoverableTrustFailure) &#123;</span><br><span class="line">                <span class="comment">// not trusted, for some reason other than being expired</span></span><br><span class="line">                status = errSSLXCertChainInvalid;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// cannot use this certificate (fatal)</span></span><br><span class="line">                status = errSSLBadCert;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (peerTrust)</span><br><span class="line">                CFRelease(peerTrust);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (status == noErr) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status != errSSLWouldBlock) &#123;</span><br><span class="line">            av_log(h, AV_LOG_ERROR, <span class="string">"Unable to negotiate TLS/SSL session: %i\n"</span>, (<span class="keyword">int</span>)status);</span><br><span class="line">            ret = AVERROR(EIO);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">fail:</span><br><span class="line">    tls_close(h);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> OSStatus <span class="title">tls_read_cb</span><span class="params">(SSLConnectionRef connection, <span class="keyword">void</span> *data, <span class="keyword">size_t</span> *dataLength)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    URLContext *h = (URLContext*)connection;</span><br><span class="line">    TLSContext *c = h-&gt;priv_data;</span><br><span class="line">    <span class="keyword">size_t</span> requested = *dataLength;</span><br><span class="line">    <span class="comment">/// ‰∫§Áªô‰∏ã‰∏ÄÂ±ÇÁöÑtcpÂéªÂ§ÑÁêÜ read</span></span><br><span class="line">    <span class="comment">/// ËøôÈáåËØªÂà∞ÁöÑÊï∞ÊçÆ ËøòÊ≤°ÊúâÁªèËøátlsËß£Á†ÅÔºå‰∏çÂèØËØª</span></span><br><span class="line">    <span class="keyword">int</span> read = ffurl_read(c-&gt;tls_shared.tcp, data, requested);</span><br><span class="line">    <span class="keyword">if</span> (read &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        *dataLength = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">switch</span>(AVUNERROR(read)) &#123;</span><br><span class="line">            <span class="keyword">case</span> ENOENT:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> errSSLClosedGraceful;</span><br><span class="line">            <span class="keyword">case</span> ECONNRESET:</span><br><span class="line">                <span class="keyword">return</span> errSSLClosedAbort;</span><br><span class="line">            <span class="keyword">case</span> EAGAIN:</span><br><span class="line">                <span class="keyword">return</span> errSSLWouldBlock;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                c-&gt;lastErr = read;</span><br><span class="line">                <span class="keyword">return</span> ioErr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *dataLength = read;</span><br><span class="line">        <span class="keyword">if</span> (read &lt; requested)</span><br><span class="line">            <span class="keyword">return</span> errSSLWouldBlock;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> noErr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> OSStatus <span class="title">tls_write_cb</span><span class="params">(SSLConnectionRef connection, <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> *dataLength)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    URLContext *h = (URLContext*)connection;</span><br><span class="line">    TLSContext *c = h-&gt;priv_data;</span><br><span class="line">    <span class="comment">/// ‰∫§Áªô‰∏ã‰∏ÄÂ±ÇÁöÑtcpÂéªÂ§ÑÁêÜ write</span></span><br><span class="line">    <span class="comment">/// data Â∑≤ÁªèÁªèËøáÁöÑtlsÁöÑÂä†ÂØÜÂ§ÑÁêÜ‰∫Ü„ÄÇ‰∏çÂèØËØª</span></span><br><span class="line">    <span class="keyword">int</span> written = ffurl_write(c-&gt;tls_shared.tcp, data, *dataLength);</span><br><span class="line">    <span class="keyword">if</span> (written &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        *dataLength = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">switch</span>(AVUNERROR(written)) &#123;</span><br><span class="line">            <span class="keyword">case</span> EAGAIN:</span><br><span class="line">                <span class="keyword">return</span> errSSLWouldBlock;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                c-&gt;lastErr = written;</span><br><span class="line">                <span class="keyword">return</span> ioErr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *dataLength = written;</span><br><span class="line">        <span class="keyword">return</span> noErr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tls_read</span><span class="params">(URLContext *h, <span class="keyword">uint8_t</span> *buf, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TLSContext *c = h-&gt;priv_data;</span><br><span class="line">    <span class="keyword">size_t</span> available = <span class="number">0</span>, processed = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    SSLGetBufferedReadSize(c-&gt;ssl_context, &amp;available);</span><br><span class="line">    <span class="keyword">if</span> (available)</span><br><span class="line">        size = FFMIN(available, size);</span><br><span class="line">    <span class="comment">/// ËØªÊï∞ÊçÆÔºåËøôÈáåËØªÂà∞ÁöÑÊï∞ÊçÆÂ∑≤ÁªèÁªèËøáÁöÑtlsÁöÑËß£ÂØÜÔºåÊòØÊòéÊñá‰∫Ü Êñ≠ÁÇπÂèØ‰ª•Êü•ÁúãÊï∞ÊçÆ        </span></span><br><span class="line">    ret = SSLRead(c-&gt;ssl_context, buf, size, &amp;processed);</span><br><span class="line">    ret = map_ssl_error(ret, processed);</span><br><span class="line">    <span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> AVERROR_EOF;</span><br><span class="line">    <span class="keyword">return</span> print_tls_error(h, ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tls_write</span><span class="params">(URLContext *h, <span class="keyword">const</span> <span class="keyword">uint8_t</span> *buf, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TLSContext *c = h-&gt;priv_data;</span><br><span class="line">    <span class="keyword">size_t</span> processed = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/// ÂÜôÊï∞ÊçÆÔºåÂ∫îÁî®Â±ÇÁöÑÊï∞ÊçÆËøòÊ≤°ÊúâÁªèËøátlsÁöÑÂä†ÂØÜÔºåÊñ≠ÁÇπÂèØËØª</span></span><br><span class="line">    <span class="keyword">int</span> ret = SSLWrite(c-&gt;ssl_context, buf, size, &amp;processed);</span><br><span class="line">    ret = map_ssl_error(ret, processed);</span><br><span class="line">    <span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> AVERROR_EOF;</span><br><span class="line">    <span class="keyword">return</span> print_tls_error(h, ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">libavformat/tls.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ff_tls_open_underlying</span><span class="params">(TLSShared *c, URLContext *parent, <span class="keyword">const</span> <span class="keyword">char</span> *uri, AVDictionary **options)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> port;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *p;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">200</span>], opts[<span class="number">50</span>] = <span class="string">""</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span> = &#123;</span> <span class="number">0</span> &#125;, *ai = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *proxy_path;</span><br><span class="line">    <span class="keyword">char</span> *env_http_proxy, *env_no_proxy;</span><br><span class="line">    <span class="keyword">int</span> use_proxy;</span><br><span class="line"></span><br><span class="line">    set_options(c, uri);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;listen)</span><br><span class="line">        <span class="built_in">snprintf</span>(opts, <span class="keyword">sizeof</span>(opts), <span class="string">"?listen=1"</span>);</span><br><span class="line"></span><br><span class="line">    av_url_split(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>, c-&gt;underlying_host, <span class="keyword">sizeof</span>(c-&gt;underlying_host), &amp;port, <span class="literal">NULL</span>, <span class="number">0</span>, uri);</span><br><span class="line"></span><br><span class="line">    p = <span class="built_in">strchr</span>(uri, <span class="string">'?'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!p) &#123;</span><br><span class="line">        p = opts;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (av_find_info_tag(opts, <span class="keyword">sizeof</span>(opts), <span class="string">"listen"</span>, p))</span><br><span class="line">            c-&gt;listen = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ff_url_join(buf, <span class="keyword">sizeof</span>(buf), <span class="string">"tcp"</span>, <span class="literal">NULL</span>, c-&gt;underlying_host, port, <span class="string">"%s"</span>, p);</span><br><span class="line"></span><br><span class="line">    hints.ai_flags = AI_NUMERICHOST;</span><br><span class="line">    <span class="keyword">if</span> (!getaddrinfo(c-&gt;underlying_host, <span class="literal">NULL</span>, &amp;hints, &amp;ai)) &#123;</span><br><span class="line">        c-&gt;numerichost = <span class="number">1</span>;</span><br><span class="line">        freeaddrinfo(ai);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!c-&gt;host &amp;&amp; !(c-&gt;host = av_strdup(c-&gt;underlying_host)))</span><br><span class="line">        <span class="keyword">return</span> AVERROR(ENOMEM);</span><br><span class="line"></span><br><span class="line">    env_http_proxy = getenv_utf8(<span class="string">"http_proxy"</span>);</span><br><span class="line">    proxy_path = c-&gt;http_proxy ? c-&gt;http_proxy : env_http_proxy;</span><br><span class="line"></span><br><span class="line">    env_no_proxy = getenv_utf8(<span class="string">"no_proxy"</span>);</span><br><span class="line">    use_proxy = !ff_http_match_no_proxy(env_no_proxy, c-&gt;underlying_host) &amp;&amp;</span><br><span class="line">                proxy_path &amp;&amp; av_strstart(proxy_path, <span class="string">"http://"</span>, <span class="literal">NULL</span>);</span><br><span class="line">    freeenv_utf8(env_no_proxy);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (use_proxy) &#123;</span><br><span class="line">        <span class="keyword">char</span> proxy_host[<span class="number">200</span>], proxy_auth[<span class="number">200</span>], dest[<span class="number">200</span>];</span><br><span class="line">        <span class="keyword">int</span> proxy_port;</span><br><span class="line">        av_url_split(<span class="literal">NULL</span>, <span class="number">0</span>, proxy_auth, <span class="keyword">sizeof</span>(proxy_auth),</span><br><span class="line">                     proxy_host, <span class="keyword">sizeof</span>(proxy_host), &amp;proxy_port, <span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">                     proxy_path);</span><br><span class="line">        ff_url_join(dest, <span class="keyword">sizeof</span>(dest), <span class="literal">NULL</span>, <span class="literal">NULL</span>, c-&gt;underlying_host, port, <span class="literal">NULL</span>);</span><br><span class="line">        ff_url_join(buf, <span class="keyword">sizeof</span>(buf), <span class="string">"httpproxy"</span>, proxy_auth, proxy_host,</span><br><span class="line">                    proxy_port, <span class="string">"/%s"</span>, dest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    freeenv_utf8(env_http_proxy);</span><br><span class="line"></span><br><span class="line">    <span class="comment">///ÁÜüÊÇâÁöÑÊñπÊ≥ïÔºåÊ†πÊçÆ‰∏äÈù¢ÊãºÊé•ÁöÑtcp://  ÊâìÂºÄtcp </span></span><br><span class="line">    <span class="keyword">return</span> ffurl_open_whitelist(&amp;c-&gt;tcp, buf, AVIO_FLAG_READ_WRITE,</span><br><span class="line">                                &amp;parent-&gt;interrupt_callback, options,</span><br><span class="line">                                parent-&gt;protocol_whitelist, parent-&gt;protocol_blacklist, parent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>tlsËøôÂùóÁöÑÂ§ÑÁêÜÈÄªËæë ‰Ωú‰∏∫http Ë∑ü tcpÁöÑ‰∏≠Èó¥Â±ÇÔºåÈÉΩÊòØÈÅµÂæ™ÁöÑURLProtocolÂçèËÆÆÔºåÊâÄ‰ª•ÊµÅÁ®ãÂü∫Êú¨Ë∑ühttp„ÄÅtcp‰∏ÄÊ†∑„ÄÇ<br>ÂÖ≥ÈîÆÁÇπ‰πüÂêåÊ†∑Âä†‰∫ÜÂØπÂ∫îÁöÑÊ≥®ÈáäËæÖÂä©ÁêÜËß£ÔºåÂÖ≥‰∫ésslcontext ËßÅ‰∏ãÈù¢ÁöÑËãπÊûúÊñáÊ°£Ôºå Â¶ÇÊûúÁÜüÊÇâtlsÁöÑÂõõÊ¨°Êè°ÊâãÔºåÂü∫Êú¨ËøòÊòØÂèØ‰ª•ÁêÜËß£„ÄÇ</p>
<h3 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h3><p>Êï¥‰∏™‰ª£Á†ÅËøáÁ®ãÈ°∫‰∏ãÊù•ÔºåÂü∫Êú¨Â∞±ÊòØÁΩëÁªúÂçèËÆÆÁöÑË∞ÉÁî®ËøáÁ®ãÔºåhttp/https -&gt; ssl/tls -&gt; tcp(socket)</p>
<p>ÊúÄÂêéÊù•‰∏ÄÂº†<strong>wireshark</strong>ÁöÑÊäìÂåÖÔºåÂæàÊòéÊòæÁúãÂà∞‰ªétcpÁöÑ‰∏âÊ¨°Êè°ÊâãÂºÄÂßãÔºå Á¥ßÊé•ÁùÄtlsÁöÑÂõõÊ¨°ÊçÇÊâãÔºåÁÑ∂ÂêéÂ∞±ÊòØÁúüÊ≠£ÁöÑËØ∑Ê±ÇÊï∞ÊçÆÁöÑ‰º†Ëæì‰∫Ü‚Ä¶</p>
<p><img src="/images/20230112_115542_image.png" alt="IMAGE"></p>
<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><p><a href="https://developer.apple.com/documentation/security/secure_transport/using_the_secure_socket_layer_for_network_communication?language=objc" target="_blank" rel="noopener">#macos security</a></p>

      
    </div>

    
      

  <div class="popular-posts-header">Áõ∏ÂÖ≥ÊñáÁ´†</div>
  <ul class="popular-posts">
  
    <li class="popular-posts-item">
      
      
      <div class="popular-posts-title"><a href="/2023/01/16/ffmpegÊ∫êÁ†Å‰πãxxÂ≠¶‰π†Á¨îËÆ∞/" rel="bookmark">ffmpegÊ∫êÁ†Å‰πãxxÂ≠¶‰π†Á¨îËÆ∞</a></div>
      
    </li>
  
  </ul>


    

    
    
    

    

    
      
    
    
      <div>
        <div id="reward-container">
  <div></div>
  <button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    ÊâìËµè
  </button>
  <div id="qr" style="display: none;">

    
      
      
        
      
      <div style="display: inline-block">
        <img src="/images/wechatpay.png" alt="BLACK_OX ÂæÆ‰ø°ÊîØ‰ªò">
        <p>ÂæÆ‰ø°ÊîØ‰ªò</p>
      </div>
    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ffmepg/" rel="tag"><i class="fa fa-tag"></i> ffmepg</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/11/04/iosËé∑Âèñudid/" rel="next" title="iosËé∑Âèñudid">
                <i class="fa fa-chevron-left"></i> iosËé∑Âèñudid
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2023/01/16/ffmpegÊ∫êÁ†Å‰πãxxÂ≠¶‰π†Á¨îËÆ∞/" rel="prev" title="ffmpegÊ∫êÁ†Å‰πãxxÂ≠¶‰π†Á¨îËÆ∞">
                ffmpegÊ∫êÁ†Å‰πãxxÂ≠¶‰π†Á¨îËÆ∞ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            ÊñáÁ´†ÁõÆÂΩï
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Á´ôÁÇπÊ¶ÇËßà
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="BLACK_OX">
            
              <p class="site-author-name" itemprop="name">BLACK_OX</p>
              <div class="site-description motion-element" itemprop="description">Developer...</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">32</span>
                    <span class="site-state-item-name">Êó•Âøó</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">ÂàÜÁ±ª</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">17</span>
                    <span class="site-state-item-name">Ê†áÁ≠æ</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/blackox626" title="GitHub &rarr; https://github.com/blackox626" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:blackox626@gmail.com" title="E-Mail &rarr; mailto:blackox626@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#respect"><span class="nav-text">respect</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#start"><span class="nav-text">start</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#class-relation"><span class="nav-text">class relation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSL-TLS"><span class="nav-text">SSL/TLS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#summary"><span class="nav-text">summary</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reference"><span class="nav-text">reference</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">BLACK_OX</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="Á´ôÁÇπÊÄªÂ≠óÊï∞">476k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="Á´ôÁÇπÈòÖËØªÊó∂Èïø">7:13</span>
  
</div>


  <div class="powered-by">Áî± <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> Âº∫ÂäõÈ©±Âä®</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">‰∏ªÈ¢ò ‚Äì <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a></div>




<div class="visit-by">
  <i class="fa fa-eye"></i>
  <span id="busuanzi_container_site_pv">
    <span id="busuanzi_value_site_pv"></span>
  </span>

  <span class="post-meta-divider">|</span>

  <i class="fa fa-user"></i>
    <span id="busuanzi_container_site_uv">
      <span id="busuanzi_value_site_uv"></span>
    </span>
</div>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/affix.js?v=7.1.1"></script>

  <script src="/js/schemes/pisces.js?v=7.1.1"></script>




  
  <script src="/js/scrollspy.js?v=7.1.1"></script>
<script src="/js/post-details.js?v=7.1.1"></script>



  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  

  

  
  

<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: true,
    appId: '98visuelOUQ19xFr1vzfJcKo-gzGzoHsz',
    appKey: 'oS6B9UYaqn8BBWkzY9icYxB9',
    placeholder: 'Just go go',
    avatar: 'robohash',
    meta: guest,
    pageSize: '10' || 10,
    visitor: true,
    lang: '' || 'zh-cn'
  });
</script>




  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  
  
  
  <script src="/lib/pangu/dist/pangu.min.js?v=3.3"></script>
  <script>pangu.spacingPage();</script>


  

  

  

  

</body>
</html>
